-- ==================== AUTO BANK MODULE ====================
-- Ch·ª©c nƒÉng: T·ª± ƒë·ªông b·ªè v≈© kh√≠ v√† pet c√≥ gi√° tr·ªã v√†o Bank
-- Requirements: WindUI, global variables from main script
-- ===========================================================

local Module = {}

-- T·∫Øt to√†n b·ªô log console trong module n√†y
local warn = function(...) end

-- ‚úÖ Fetch required globals from the main script
local WindUI = _G.WindUI
local Window = _G.Window
local Players = game:GetService("Players")
local c = _G.PlayerLocal
local d = _G.UserId
local e = _G.HttpService
local ConfigSystem = _G.ConfigSystem
local Toggles = _G.Toggles
local Options = _G.Options
local bQ = _G.GearPerks  -- Perk data
local bR = _G.ItemsModule  -- Items data

-- ‚úÖ Fetch ReplicatedStorage references
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Bank = Shared:WaitForChild("Bank")
local TransferToBank = Bank:WaitForChild("TransferToBank")
local WithdrawFromBank = Bank:WaitForChild("WithdrawFromBank")

-- ‚úÖ Fetch Player references
local PlayerGui = c:WaitForChild("PlayerGui")
local Profile = PlayerGui:WaitForChild("Profile")
local InventoryItems = Profile:WaitForChild("Inventory"):WaitForChild("Items")
local BankGui = PlayerGui:WaitForChild("Bank")
local BankItems = BankGui:WaitForChild("Bank"):WaitForChild("BankItems")
local BankCounter = BankItems:WaitForChild("Counter")

-- ==================== GLOBALS ====================
local BankGlobals = {
    -- Auto Bank toggles
    isAutoBankingWeapons = false,
    isAutoBankingPets = false,
    isAutoBankingAllWeapons = false, -- Bank t·∫•t c·∫£ weapons kh√¥ng c·∫ßn ƒëi·ªÅu ki·ªán
    isAutoBankingAllPets = false, -- Bank t·∫•t c·∫£ pets kh√¥ng c·∫ßn ƒëi·ªÅu ki·ªán
    
    -- Config cho weapons v√† pets (ch·ªâ l∆∞u min tier)
    weaponMinTier = 5, -- Tier t·ªëi thi·ªÉu ƒë·ªÉ bank (m·∫∑c ƒë·ªãnh T5)
    petMinTier = 5, -- Tier t·ªëi thi·ªÉu ƒë·ªÉ bank (m·∫∑c ƒë·ªãnh T5)
    
    -- Statistics
    totalWeaponsBanked = 0,
    totalPetsBanked = 0,
    sessionStartTime = 0,
    
    -- Config file
    ConfigFile = "AnyaHub_BankConfig_" .. c.Name .. ".txt"
}

-- ==================== UTILITY FUNCTIONS ====================
local function libNoti(msg, duration)
    WindUI:Notify({
        Title = "Auto Bank",
        Content = msg,
        Duration = duration or 5
    })
end

local function formatNumber(num)
    if num >= 1000000 then
        return string.format("%.1fM", num / 1000000)
    elseif num >= 1000 then
        return string.format("%.1fK", num / 1000)
    else
        return tostring(num)
    end
end

local function timeElapsed(seconds)
    local hours = math.floor(seconds / 3600)
    local mins = math.floor((seconds % 3600) / 60)
    local secs = seconds % 60
    
    if hours > 0 then
        return string.format("%dh %dm %ds", hours, mins, secs)
    elseif mins > 0 then
        return string.format("%dm %ds", mins, secs)
    else
        return string.format("%ds", secs)
    end
end

-- ==================== BANK FUNCTIONS ====================
-- L·∫•y th√¥ng tin bank capacity (18/50)
local function getBankInfo()
    if not BankCounter or not BankCounter.Value then
        return 0, 0
    end
    
    local counterText = BankCounter.Value
    local current, max = string.match(counterText, "(%d+)/(%d+)")
    
    return tonumber(current) or 0, tonumber(max) or 0
end

-- Ki·ªÉm tra xem bank c√≥ ƒë·∫ßy kh√¥ng
local function isBankFull()
    local current, max = getBankInfo()
    return current >= max
end

-- B·ªè item v√†o bank
local function transferToBank(item, quantity)
    if not item or not item.Parent then
        return false
    end
    
    if isBankFull() then
        libNoti("‚ö†Ô∏è Bank ƒë√£ ƒë·∫ßy! Kh√¥ng th·ªÉ th√™m item.", 3)
        return false
    end
    
    local success = pcall(function()
        TransferToBank:FireServer(item, quantity or 1)
    end)
    
    if success then
        task.wait(0.2) -- Wait for replication
    end
    
    return success
end

-- L·∫•y item t·ª´ bank
local function withdrawFromBank(item, quantity)
    if not item or not item.Parent then
        return false
    end
    
    local success = pcall(function()
        WithdrawFromBank:FireServer(item, quantity or 1)
    end)
    
    if success then
        task.wait(0.2) -- Wait for replication
    end
    
    return success
end

-- ==================== WEAPON FUNCTIONS ====================
-- L·∫•y tier c·ªßa weapon
local function getWeaponTier(weaponItem)
    if not weaponItem or not weaponItem:FindFirstChild("Tier") then
        return nil
    end
    
    return weaponItem.Tier.Value
end

-- Ki·ªÉm tra weapon c√≥ ƒë√°p ·ª©ng ƒëi·ªÅu ki·ªán bank kh√¥ng
local function shouldBankWeapon(weaponItem)
    local itemData = bR[weaponItem.Name]
    if not itemData or (itemData.Type ~= "Weapon" and itemData.Type ~= "Armor") then
        return false, "Not a weapon/armor"
    end
    
    -- Ki·ªÉm tra tier
    local tier = getWeaponTier(weaponItem)
    if not tier or tier < BankGlobals.weaponMinTier then
        return false, string.format("Tier %d < min tier %d", tier or 0, BankGlobals.weaponMinTier)
    end
    
    -- Ki·ªÉm tra perks (s·ª≠ d·ª•ng Options t·ª´ main script)
    local hasValidPerk = false
    local bestPerkInfo = nil
    local shouldKeep = false
    
    for _, child in ipairs(weaponItem:GetChildren()) do
        if child:IsA("StringValue") and child:FindFirstChild("PerkValue") then
            local perkName = child.Value
            local perkValue = child.PerkValue.Value
            
            local perkData = bQ[perkName]
            
            if perkData then
                local canAppearOnWeapon = not perkData.ArmorOnly and not perkData.PetOnly
                local statRange = perkData.StatRange
                
                if canAppearOnWeapon and statRange then
                    hasValidPerk = true
                    
                    -- ‚úÖ L·∫•y threshold t·ª´ Options (gi·ªëng smartPerkSell)
                    local threshold = 999
                    if _G.Options and _G.Options[perkName] then
                        threshold = tonumber(_G.Options[perkName].Value) or 999
                    end
                    
                    local perkPercent = math.round(perkValue * 100)
                    local meetsThreshold = perkPercent >= threshold
                    
                    if meetsThreshold and not shouldKeep then
                        shouldKeep = true
                    end
                    
                    if not bestPerkInfo or meetsThreshold or (not shouldKeep and perkPercent > bestPerkInfo.value) then
                        bestPerkInfo = {
                            name = perkData.DisplayName,
                            value = perkPercent,
                            threshold = threshold,
                            meets = meetsThreshold
                        }
                    end
                end
            end
        end
    end
    
    if not hasValidPerk then
        return false, "No valid perk"
    end
    
    if not shouldKeep then
        return false, string.format("%s: %.1f%% < %.1f%%", bestPerkInfo.name, bestPerkInfo.value, bestPerkInfo.threshold)
    end
    
    return true, string.format("%s: %.1f%% ‚â• %.1f%%", bestPerkInfo.name, bestPerkInfo.value, bestPerkInfo.threshold)
end

-- L·∫•y t·∫•t c·∫£ weapons trong inventory
local function getAllWeaponsInInventory()
    local weapons = {}
    
    for _, item in ipairs(InventoryItems:GetChildren()) do
        if item:IsA("Folder") then
            local itemData = bR[item.Name]
            if itemData and (itemData.Type == "Weapon" or itemData.Type == "Armor") then
                table.insert(weapons, item)
            end
        end
    end
    
    return weapons
end

-- Bank m·ªôt weapon
local function bankWeapon(weaponItem, skipCheck)
    local shouldBank, reason
    
    if skipCheck then
        -- Kh√¥ng ki·ªÉm tra ƒëi·ªÅu ki·ªán, bank lu√¥n
        shouldBank = true
        reason = "Auto bank all enabled"
    else
        shouldBank, reason = shouldBankWeapon(weaponItem)
    end
    
    if not shouldBank then
        return false, reason
    end
    
    local success = transferToBank(weaponItem, 1)
    
    if success then
        BankGlobals.totalWeaponsBanked = BankGlobals.totalWeaponsBanked + 1
        local itemData = bR[weaponItem.Name]
        if not skipCheck then
            libNoti(string.format("‚úÖ Banked weapon: %s | %s", itemData.DisplayKey or weaponItem.Name, reason), 2)
        end
    end
    
    return success, reason
end

-- ==================== PET FUNCTIONS ====================
-- L·∫•y tier c·ªßa pet
local function getPetTier(petItem)
    if not petItem or not petItem:FindFirstChild("Variant") then
        return nil
    end
    
    local petName = petItem.Name
    local variantValue = petItem.Variant.Value
    
    local itemData = bR[petName]
    if not itemData or itemData.Type ~= "Pet" or not itemData.Variants then
        return nil
    end
    
    for _, variant in ipairs(itemData.Variants) do
        if variant[1] == variantValue then
            return variant[4]
        end
    end
    
    return nil
end

-- Ki·ªÉm tra pet c√≥ ƒë√°p ·ª©ng ƒëi·ªÅu ki·ªán bank kh√¥ng
local function shouldBankPet(petItem)
    local itemData = bR[petItem.Name]
    if not itemData or itemData.Type ~= "Pet" then
        return false, "Not a pet"
    end
    
    -- Ki·ªÉm tra tier
    local tier = getPetTier(petItem)
    if not tier or tier < BankGlobals.petMinTier then
        return false, string.format("Tier %d < min tier %d", tier or 0, BankGlobals.petMinTier)
    end
    
    -- Ki·ªÉm tra perks (l·∫•y t·ª´ module Auto Hatch n·∫øu c√≥, ho·∫∑c t·ª´ config)
    local hasValidPerk = false
    local bestPerkInfo = nil
    local shouldKeep = false
    
    -- ‚úÖ Fetch pet perk thresholds t·ª´ config ƒë√£ load
    local petPerkThresholds = {}
    if _G.ConfigSystem and _G.ConfigSystem.lastLoadedConfig and _G.ConfigSystem.lastLoadedConfig.HatchGlobals then
        local hatchConfig = _G.ConfigSystem.lastLoadedConfig.HatchGlobals
        if hatchConfig.petPerkThresholds then
            for key, value in pairs(hatchConfig.petPerkThresholds) do
                -- Remove prefix "PetPerk_" if exists
                local perkKey = key
                if string.sub(key, 1, 8) == "PetPerk_" then
                    perkKey = string.sub(key, 9)
                end
                petPerkThresholds[perkKey] = tonumber(value) or 999
            end
        end
    end
    
    for _, child in ipairs(petItem:GetChildren()) do
        if child:IsA("StringValue") and child:FindFirstChild("PerkValue") then
            local perkName = child.Value
            local perkValue = child.PerkValue.Value
            
            local perkData = bQ[perkName]
            
            if perkData then
                local canAppearOnPet = (not perkData.WeaponOnly and not perkData.ArmorOnly) or perkData.PetOnly
                local statRange = perkData.PetStatRange or perkData.StatRange
                
                if canAppearOnPet and statRange then
                    hasValidPerk = true
                    
                    -- ‚úÖ L·∫•y threshold t·ª´ petPerkThresholds (gi·ªëng Auto Hatch)
                    local threshold = petPerkThresholds[perkName] or 999
                    
                    local perkPercent = math.round(perkValue * 100)
                    local meetsThreshold = perkPercent >= threshold
                    
                    if meetsThreshold and not shouldKeep then
                        shouldKeep = true
                    end
                    
                    if not bestPerkInfo or meetsThreshold or (not shouldKeep and perkPercent > bestPerkInfo.value) then
                        bestPerkInfo = {
                            name = perkData.DisplayName,
                            value = perkPercent,
                            threshold = threshold,
                            meets = meetsThreshold
                        }
                    end
                end
            end
        end
    end
    
    if not hasValidPerk then
        return false, "No valid perk"
    end
    
    if not shouldKeep then
        return false, string.format("%s: %.1f%% < %.1f%%", bestPerkInfo.name, bestPerkInfo.value, bestPerkInfo.threshold)
    end
    
    return true, string.format("%s: %.1f%% ‚â• %.1f%%", bestPerkInfo.name, bestPerkInfo.value, bestPerkInfo.threshold)
end

-- L·∫•y t·∫•t c·∫£ pets trong inventory
local function getAllPetsInInventory()
    local pets = {}
    
    for _, item in ipairs(InventoryItems:GetChildren()) do
        if item:IsA("Folder") then
            local itemData = bR[item.Name]
            if itemData and itemData.Type == "Pet" then
                table.insert(pets, item)
            end
        end
    end
    
    return pets
end

-- Bank m·ªôt pet
local function bankPet(petItem, skipCheck)
    local shouldBank, reason
    
    if skipCheck then
        -- Kh√¥ng ki·ªÉm tra ƒëi·ªÅu ki·ªán, bank lu√¥n
        shouldBank = true
        reason = "Auto bank all enabled"
    else
        shouldBank, reason = shouldBankPet(petItem)
    end
    
    if not shouldBank then
        return false, reason
    end
    
    local success = transferToBank(petItem, 1)
    
    if success then
        BankGlobals.totalPetsBanked = BankGlobals.totalPetsBanked + 1
        local itemData = bR[petItem.Name]
        if not skipCheck then
            libNoti(string.format("‚úÖ Banked pet: %s | %s", itemData.DisplayKey or petItem.Name, reason), 2)
        end
    end
    
    return success, reason
end

-- ==================== AUTO FUNCTIONS ====================
local function startAutoBank()
    if BankGlobals.sessionStartTime == 0 then
        BankGlobals.sessionStartTime = tick()
    end
    
    -- ‚úÖ Listener chung cho c·∫£ weapons v√† pets
    InventoryItems.ChildAdded:Connect(function(item)
        task.wait(0.1)
        
        local itemData = bR[item.Name]
        if not itemData then
            return
        end
        
        -- Ki·ªÉm tra Auto Bank Weapons
        if itemData.Type == "Weapon" or itemData.Type == "Armor" then
            local autoBankAllWeapons = _G.Toggles and _G.Toggles.AutoBankAllWeapons and _G.Toggles.AutoBankAllWeapons.Value or false
            local autoBankWeapons = _G.Toggles and _G.Toggles.AutoBankWeapons and _G.Toggles.AutoBankWeapons.Value or false
            
            if autoBankAllWeapons then
                -- Bank t·∫•t c·∫£ weapons kh√¥ng c·∫ßn ki·ªÉm tra
                bankWeapon(item, true)
            elseif autoBankWeapons then
                -- Bank weapons c√≥ ƒëi·ªÅu ki·ªán
                bankWeapon(item, false)
            end
        end
        
        -- Ki·ªÉm tra Auto Bank Pets
        if itemData.Type == "Pet" then
            local autoBankAllPets = _G.Toggles and _G.Toggles.AutoBankAllPets and _G.Toggles.AutoBankAllPets.Value or false
            local autoBankPets = _G.Toggles and _G.Toggles.AutoBankPets and _G.Toggles.AutoBankPets.Value or false
            
            if autoBankAllPets then
                -- Bank t·∫•t c·∫£ pets kh√¥ng c·∫ßn ki·ªÉm tra
                bankPet(item, true)
            elseif autoBankPets then
                -- Bank pets c√≥ ƒëi·ªÅu ki·ªán
                bankPet(item, false)
            end
        end
    end)
end

-- ==================== CONFIG FUNCTIONS ====================
local function saveBankConfig()
    if not writefile then return end
    
    local data = {
        totalWeaponsBanked = BankGlobals.totalWeaponsBanked,
        totalPetsBanked = BankGlobals.totalPetsBanked
    }
    
    pcall(function()
        writefile(BankGlobals.ConfigFile, e:JSONEncode(data))
    end)
end

local function loadBankConfig()
    if not (isfile and readfile and isfile(BankGlobals.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local data = e:JSONDecode(readfile(BankGlobals.ConfigFile))
        
        BankGlobals.totalWeaponsBanked = data.totalWeaponsBanked or 0
        BankGlobals.totalPetsBanked = data.totalPetsBanked or 0
    end)
    
    return success
end

-- ==================== UI CREATION ====================
local function createInventoryTab()
    local TabInventory = Window:Tab({
        Title = "Inventory",
        Icon = "package",
        Locked = false
    })
    
    TabInventory:Section({ Title = "üè¶ Auto Bank System" })
    
    -- Paragraph hi·ªÉn th·ªã bank info
    local BankInfoParagraph = TabInventory:Paragraph({
        Title = "üìä Bank Status",
        Description = "Loading..."
    })
    
    task.spawn(function()
        while true do
            local current, max = getBankInfo()
            BankInfoParagraph:SetDesc(string.format("üì¶ Bank: %d/%d items", current, max))
            task.wait(1)
        end
    end)
    
    TabInventory:Divider({ Text = "Auto Bank Weapons" })
    
    -- Auto Bank Weapons Toggle
    local AutoBankWeaponsToggle = TabInventory:Toggle({
        Title = "‚öîÔ∏è Auto Bank Weapons (Smart)",
        Description = "T·ª± ƒë·ªông bank weapons ƒë·ªß ƒëi·ªÅu ki·ªán khi nh·∫≠n ƒë∆∞·ª£c",
        Default = false,
        Callback = function(state)
            if _G.Toggles and _G.Toggles.AutoBankWeapons then
                _G.Toggles.AutoBankWeapons:SetValue(state)
            end
            BankGlobals.isAutoBankingWeapons = state
            
            if state then
                libNoti("‚úÖ Auto Bank Weapons (Smart) ƒë√£ B·∫¨T", 2)
            else
                libNoti("‚ùå Auto Bank Weapons (Smart) ƒë√£ T·∫ÆT", 2)
            end
        end
    })
    ConfigSystem.registerUIElement("AutoBankWeapons", AutoBankWeaponsToggle)
    
    -- Weapon Min Tier Slider
    local WeaponMinTierSlider = TabInventory:Slider({
        Title = "Weapon Min Tier",
        Description = "Tier t·ªëi thi·ªÉu ƒë·ªÉ bank weapon",
        Step = 1,
        Value = {
            Min = 1,
            Max = 5,
            Default = BankGlobals.weaponMinTier
        },
        Callback = function(value)
            BankGlobals.weaponMinTier = value
        end
    })
    ConfigSystem.registerUIElement("BankWeaponMinTier", WeaponMinTierSlider)
    
    -- ‚úÖ Paragraph h∆∞·ªõng d·∫´n
    TabInventory:Paragraph({
        Title = "‚ÑπÔ∏è Weapon Perk Settings",
        Description = "Weapon perks s·ª≠ d·ª•ng ng∆∞·ª°ng t·ª´ Smart T5 Auto Sell.\nƒê·ªÉ thay ƒë·ªïi, v√†o tab Auto Sell > Smart T5 Auto Sell."
    })
    
    -- Auto Bank All Weapons Toggle
    local AutoBankAllWeaponsToggle = TabInventory:Toggle({
        Title = "‚öîÔ∏è Auto Bank ALL Weapons",
        Description = "Bank T·∫§T C·∫¢ weapons (b·ªè qua m·ªçi ƒëi·ªÅu ki·ªán)",
        Default = false,
        Callback = function(state)
            if _G.Toggles and _G.Toggles.AutoBankAllWeapons then
                _G.Toggles.AutoBankAllWeapons:SetValue(state)
            end
            BankGlobals.isAutoBankingAllWeapons = state
            
            if state then
                libNoti("‚ö†Ô∏è Auto Bank ALL Weapons ƒë√£ B·∫¨T - M·ªçi weapon s·∫Ω ƒë∆∞·ª£c bank!", 3)
            else
                libNoti("‚ùå Auto Bank ALL Weapons ƒë√£ T·∫ÆT", 2)
            end
        end
    })
    ConfigSystem.registerUIElement("AutoBankAllWeapons", AutoBankAllWeaponsToggle)
    
    TabInventory:Divider({ Text = "Auto Bank Pets" })
    
    -- Auto Bank Pets Toggle
    local AutoBankPetsToggle = TabInventory:Toggle({
        Title = "üêæ Auto Bank Pets (Smart)",
        Description = "T·ª± ƒë·ªông bank pets ƒë·ªß ƒëi·ªÅu ki·ªán khi nh·∫≠n ƒë∆∞·ª£c",
        Default = false,
        Callback = function(state)
            if _G.Toggles and _G.Toggles.AutoBankPets then
                _G.Toggles.AutoBankPets:SetValue(state)
            end
            BankGlobals.isAutoBankingPets = state
            
            if state then
                libNoti("‚úÖ Auto Bank Pets (Smart) ƒë√£ B·∫¨T", 2)
            else
                libNoti("‚ùå Auto Bank Pets (Smart) ƒë√£ T·∫ÆT", 2)
            end
        end
    })
    ConfigSystem.registerUIElement("AutoBankPets", AutoBankPetsToggle)
    
    -- Pet Min Tier Slider
    local PetMinTierSlider = TabInventory:Slider({
        Title = "Pet Min Tier",
        Description = "Tier t·ªëi thi·ªÉu ƒë·ªÉ bank pet",
        Step = 1,
        Value = {
            Min = 1,
            Max = 5,
            Default = BankGlobals.petMinTier
        },
        Callback = function(value)
            BankGlobals.petMinTier = value
        end
    })
    ConfigSystem.registerUIElement("BankPetMinTier", PetMinTierSlider)
    
    -- ‚úÖ Paragraph h∆∞·ªõng d·∫´n
    TabInventory:Paragraph({
        Title = "‚ÑπÔ∏è Pet Perk Settings",
        Description = "Pet perks s·ª≠ d·ª•ng ng∆∞·ª°ng t·ª´ Auto Hatch tab.\nƒê·ªÉ thay ƒë·ªïi, v√†o tab Auto Hatch > Smart Pet Keep Thresholds."
    })
    
    -- Auto Bank All Pets Toggle
    local AutoBankAllPetsToggle = TabInventory:Toggle({
        Title = "üêæ Auto Bank ALL Pets",
        Description = "Bank T·∫§T C·∫¢ pets (b·ªè qua m·ªçi ƒëi·ªÅu ki·ªán)",
        Default = false,
        Callback = function(state)
            if _G.Toggles and _G.Toggles.AutoBankAllPets then
                _G.Toggles.AutoBankAllPets:SetValue(state)
            end
            BankGlobals.isAutoBankingAllPets = state
            
            if state then
                libNoti("‚ö†Ô∏è Auto Bank ALL Pets ƒë√£ B·∫¨T - M·ªçi pet s·∫Ω ƒë∆∞·ª£c bank!", 3)
            else
                libNoti("‚ùå Auto Bank ALL Pets ƒë√£ T·∫ÆT", 2)
            end
        end
    })
    ConfigSystem.registerUIElement("AutoBankAllPets", AutoBankAllPetsToggle)
    
    TabInventory:Divider({ Text = "Manual Actions" })
    
    -- Button Bank All Weapons
    TabInventory:Button({
        Title = "‚öîÔ∏è Bank All Qualifying Weapons",
        Description = "Bank t·∫•t c·∫£ weapons ƒë·ªß ƒëi·ªÅu ki·ªán (double-click)",
        Callback = function()
            local weapons = getAllWeaponsInInventory()
            local bankedCount = 0
            
            for _, weapon in ipairs(weapons) do
                local success, reason = bankWeapon(weapon, false)
                if success then
                    bankedCount = bankedCount + 1
                    task.wait(0.2)
                end
            end
            
            if bankedCount > 0 then
                libNoti(string.format("‚úÖ ƒê√£ bank %d weapons!", bankedCount), 3)
            else
                libNoti("‚ö†Ô∏è Kh√¥ng c√≥ weapon n√†o ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ bank", 3)
            end
        end
    })
    
    -- Button Bank All Pets
    TabInventory:Button({
        Title = "üêæ Bank All Qualifying Pets",
        Description = "Bank t·∫•t c·∫£ pets ƒë·ªß ƒëi·ªÅu ki·ªán (double-click)",
        Callback = function()
            local pets = getAllPetsInInventory()
            local bankedCount = 0
            
            for _, pet in ipairs(pets) do
                local success, reason = bankPet(pet, false)
                if success then
                    bankedCount = bankedCount + 1
                    task.wait(0.2)
                end
            end
            
            if bankedCount > 0 then
                libNoti(string.format("‚úÖ ƒê√£ bank %d pets!", bankedCount), 3)
            else
                libNoti("‚ö†Ô∏è Kh√¥ng c√≥ pet n√†o ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ bank", 3)
            end
        end
    })
    
    TabInventory:Divider({ Text = "Withdraw from Bank" })
    
    -- Button Withdraw All Weapons
    TabInventory:Button({
        Title = "‚¨áÔ∏è Withdraw All Weapons",
        Description = "R√∫t t·∫•t c·∫£ weapons t·ª´ bank (double-click)",
        Callback = function()
            local BankItemsFolder = Profile:WaitForChild("Bank"):WaitForChild("Items")
            local withdrawnCount = 0
            
            for _, item in ipairs(BankItemsFolder:GetChildren()) do
                if item:IsA("Folder") then
                    local itemData = bR[item.Name]
                    if itemData and (itemData.Type == "Weapon" or itemData.Type == "Armor") then
                        local success = withdrawFromBank(item, 1)
                        if success then
                            withdrawnCount = withdrawnCount + 1
                            task.wait(0.2)
                        end
                    end
                end
            end
            
            if withdrawnCount > 0 then
                libNoti(string.format("‚úÖ ƒê√£ r√∫t %d weapons t·ª´ bank!", withdrawnCount), 3)
            else
                libNoti("‚ö†Ô∏è Kh√¥ng c√≥ weapon n√†o trong bank", 3)
            end
        end
    })
    
    -- Button Withdraw All Pets
    TabInventory:Button({
        Title = "‚¨áÔ∏è Withdraw All Pets",
        Description = "R√∫t t·∫•t c·∫£ pets t·ª´ bank (double-click)",
        Callback = function()
            local BankItemsFolder = Profile:WaitForChild("Bank"):WaitForChild("Items")
            local withdrawnCount = 0
            
            for _, item in ipairs(BankItemsFolder:GetChildren()) do
                if item:IsA("Folder") then
                    local itemData = bR[item.Name]
                    if itemData and itemData.Type == "Pet" then
                        local success = withdrawFromBank(item, 1)
                        if success then
                            withdrawnCount = withdrawnCount + 1
                            task.wait(0.2)
                        end
                    end
                end
            end
            
            if withdrawnCount > 0 then
                libNoti(string.format("‚úÖ ƒê√£ r√∫t %d pets t·ª´ bank!", withdrawnCount), 3)
            else
                libNoti("‚ö†Ô∏è Kh√¥ng c√≥ pet n√†o trong bank", 3)
            end
        end
    })
    
    -- Button Reset Statistics
    TabInventory:Button({
        Title = "üîÑ Reset Statistics",
        Description = "Reset session statistics",
        Callback = function()
            BankGlobals.totalWeaponsBanked = 0
            BankGlobals.totalPetsBanked = 0
            BankGlobals.sessionStartTime = tick()
            saveBankConfig()
            libNoti("‚úÖ Statistics ƒë√£ ƒë∆∞·ª£c reset", 2)
        end
    })
    
    TabInventory:Divider({ Text = "Statistics" })
    
    -- Statistics Paragraph
    local StatsParagraph = TabInventory:Paragraph({
        Title = "üìä Session Stats",
        Description = "Loading..."
    })
    
    task.spawn(function()
        while true do
            local elapsed = tick() - BankGlobals.sessionStartTime
            local stats = string.format(
                "‚è±Ô∏è Time: %s\n" ..
                "‚öîÔ∏è Weapons Banked: %s\n" ..
                "üêæ Pets Banked: %s",
                timeElapsed(math.floor(elapsed)),
                formatNumber(BankGlobals.totalWeaponsBanked),
                formatNumber(BankGlobals.totalPetsBanked)
            )
            
            StatsParagraph:SetDesc(stats)
            task.wait(1)
        end
    end)
end

-- ==================== INIT MODULE ====================
function Module:Init()
    -- Load config
    loadBankConfig()
    
    -- Create UI
    createInventoryTab()
    
    -- Start auto bank listeners
    startAutoBank()
    
    -- ‚úÖ Hook v√†o ConfigSystem ƒë·ªÉ save/load BankGlobals (ch·ªâ min tiers)
    local originalGetConfigData = ConfigSystem.getConfigData
    ConfigSystem.getConfigData = function()
        local data = originalGetConfigData()
        
        -- Ch·ªâ l∆∞u min tiers (perk thresholds l·∫•y t·ª´ Options v√† HatchGlobals)
        data.BankGlobals = {
            weaponMinTier = BankGlobals.weaponMinTier,
            petMinTier = BankGlobals.petMinTier
        }
        
        return data
    end
    
    local originalLoadConfigData = ConfigSystem.loadConfigData
    ConfigSystem.loadConfigData = function(data)
        originalLoadConfigData(data)
        
        -- ‚úÖ L∆∞u config ƒë·ªÉ shouldBankPet c√≥ th·ªÉ truy c·∫≠p
        if not _G.ConfigSystem then
            _G.ConfigSystem = {}
        end
        _G.ConfigSystem.lastLoadedConfig = data
        
        if data and data.BankGlobals then
            -- Load min tiers
            if data.BankGlobals.weaponMinTier then
                BankGlobals.weaponMinTier = data.BankGlobals.weaponMinTier
            end
            
            if data.BankGlobals.petMinTier then
                BankGlobals.petMinTier = data.BankGlobals.petMinTier
            end
            
            -- Update UI sliders
            task.spawn(function()
                task.wait(0.5)
                
                -- Update weapon min tier slider
                local weaponMinTierSlider = ConfigSystem.UIElements["BankWeaponMinTier"]
                if weaponMinTierSlider and weaponMinTierSlider.Set then
                    pcall(function()
                        weaponMinTierSlider:Set(BankGlobals.weaponMinTier)
                    end)
                end
                
                -- Update pet min tier slider
                local petMinTierSlider = ConfigSystem.UIElements["BankPetMinTier"]
                if petMinTierSlider and petMinTierSlider.Set then
                    pcall(function()
                        petMinTierSlider:Set(BankGlobals.petMinTier)
                    end)
                end
            end)
        end
    end
end

return Module
